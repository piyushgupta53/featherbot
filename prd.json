{
	"project": "featherbot",
	"milestone": "M20 - Docker + Deployment",
	"branchName": "feat/m20-docker",
	"description": "Containerize FeatherBot with multi-stage Dockerfile, docker-compose.yml, env-based config, and headless mode for production deployment",
	"userStories": [
		{
			"id": "US-001",
			"title": "Dockerfile (Multi-stage Build)",
			"description": "As a developer deploying FeatherBot, I want a multi-stage Dockerfile that produces a lean production image so that I can build and run FeatherBot in a container without manual steps",
			"acceptanceCriteria": [
				"Dockerfile at repo root uses node:22-slim base",
				"Stage 1 (deps): copies package.json + pnpm-lock.yaml + pnpm-workspace.yaml, runs pnpm install --frozen-lockfile",
				"Stage 2 (build): copies source, runs pnpm build",
				"Stage 3 (runtime): copies only dist/ directories + production node_modules, no source or devDeps",
				"Runs as non-root user (featherbot)",
				"ENTRYPOINT [\"node\", \"packages/cli/dist/bin.js\"] with CMD [\"gateway\"]",
				"Image builds successfully: docker build -t featherbot .",
				"Typecheck passes (pnpm typecheck)"
			],
			"priority": 1,
			"passes": true,
			"notes": "Use corepack enable for pnpm. better-sqlite3 needs python3 + make + g++ in build stage. node:22-slim has glibc — no Alpine musl issues."
		},
		{
			"id": "US-002",
			"title": ".dockerignore",
			"description": "As a developer building Docker images, I want a .dockerignore that excludes unnecessary files so that the build context is small and builds are fast",
			"acceptanceCriteria": [
				".dockerignore at repo root excludes: node_modules/, .git/, dist/, .env*, .featherbot/, *.test.ts, .turbo/, .vscode/, .idea/, .DS_Store, .claude/, tasks/, archive/, analysis-*.md, ARCHITECTURE.md, progress.txt, prd.json",
				"Typecheck passes (pnpm typecheck)"
			],
			"priority": 2,
			"passes": true,
			"notes": "Should be created before or alongside the Dockerfile for efficient builds."
		},
		{
			"id": "US-003",
			"title": ".env.example",
			"description": "As a user deploying FeatherBot, I want a documented .env.example with all supported environment variables so that I know what to configure without reading source code",
			"acceptanceCriteria": [
				".env.example at repo root",
				"Documents all provider API keys (FEATHERBOT_providers__anthropic__apiKey, etc.)",
				"Documents channel config (Telegram token/enabled, WhatsApp enabled/authDir, Discord)",
				"Documents agent defaults (model, workspace, maxTokens, temperature)",
				"Documents tool config (web search API key, exec timeout, restrictToWorkspace)",
				"Documents session, cron, heartbeat, subagent config",
				"Each variable has a comment explaining its purpose and default value",
				"Typecheck passes (pnpm typecheck)"
			],
			"priority": 3,
			"passes": true,
			"notes": "Reference packages/core/src/config/schema.ts for all config options and defaults."
		},
		{
			"id": "US-004",
			"title": "Headless Mode (Skip Terminal Channel)",
			"description": "As a developer running FeatherBot in a container, I want the gateway to skip the terminal channel when there is no TTY so that the gateway runs cleanly without hanging on stdin",
			"acceptanceCriteria": [
				"createGateway() in packages/cli/src/commands/gateway.ts skips TerminalChannel registration when process.stdin.isTTY is falsy",
				"Gateway still registers Telegram/WhatsApp channels normally in headless mode",
				"runGateway() log output does not mention terminal when headless",
				"Existing behavior unchanged when running with a TTY",
				"Unit test verifies terminal channel is skipped when stdin is not a TTY",
				"Typecheck passes (pnpm typecheck)",
				"Tests pass (pnpm test)"
			],
			"priority": 4,
			"passes": true,
			"notes": "This is the only story that modifies existing code. All others create new files."
		},
		{
			"id": "US-005",
			"title": "docker-compose.yml",
			"description": "As a user deploying FeatherBot on a VPS, I want a docker-compose.yml for one-command deployment so that I can run docker compose up -d and have a persistent agent",
			"acceptanceCriteria": [
				"docker-compose.yml at repo root",
				"Single featherbot service that builds from local Dockerfile",
				"Volume mount for persistent data (featherbot-data -> /home/featherbot/.featherbot)",
				"env_file: .env for configuration",
				"restart: unless-stopped policy",
				"Optional: commented volume mount for custom workspace",
				"Typecheck passes (pnpm typecheck)"
			],
			"priority": 5,
			"passes": true,
			"notes": "No external services needed — SQLite is embedded, no Redis/Postgres."
		},
		{
			"id": "US-006",
			"title": "Build Smoke Test",
			"description": "As a developer maintaining the Docker setup, I want to verify the image builds and the gateway starts so that I catch Docker regressions early",
			"acceptanceCriteria": [
				"Image builds successfully with docker build -t featherbot .",
				"Container starts with minimal env vars and prints the gateway startup banner",
				"Container responds to SIGTERM with clean shutdown",
				"Document the smoke test commands in a comment block at the top of the Dockerfile",
				"Typecheck passes (pnpm typecheck)",
				"Tests pass (pnpm test)"
			],
			"priority": 6,
			"passes": true,
			"notes": "This is a manual verification story — no automated Docker test in CI. Smoke test commands documented in Dockerfile comments."
		}
	]
}
