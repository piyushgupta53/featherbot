# FeatherBot Progress Log
Started: 2026-02-08
Milestone: M20 - Docker + Deployment
---

## Codebase Patterns
- Indentation: tabs (biome enforced)
- Double quotes, semicolons (biome javascript formatter)
- ESM throughout (`"type": "module"`)
- tsconfig uses `module: "Node16"` / `moduleResolution: "Node16"`
- turbo tasks: build, typecheck, lint, test
- Node engine: >=20 (machine has v20.18.0)
- pnpm v9.15.9
- Package scripts: `build` (tsup), `typecheck` (tsc --noEmit), `lint` (biome check src/), `test` (vitest run --passWithNoTests)
- Package tsconfig extends root: `{ "extends": "../../tsconfig.json" }`
- .turbo/ directories added to .gitignore
- Imports use `.js` extension for ESM (e.g., `from "./config/schema.js"`)
- Zod schemas use `.default({})` on nested objects for full defaults cascading
- Biome forbids `!` non-null assertions — use `=== undefined` checks instead
- Biome collapses function params to one line when they fit within lineWidth (100)
- `biome-ignore lint/suspicious/noExplicitAny: reason` for necessary any casts at SDK boundaries
- Biome import sorting: `type` imports sort alphabetically by path, not grouped separately
- `biome-ignore` comments must be on the line directly above the offending line
- Biome breaks long `export { ... }` statements across multiple lines when they exceed lineWidth
- Biome `noUnusedTemplateLiteral`: use regular strings not template literals when no interpolation
- `better-sqlite3` default import: `import Database from "better-sqlite3"`, type is `Database.Database`
- Array element access needs optional chaining or a defined check for TypeScript strict mode
- Biome collapses union types onto one line when they fit within lineWidth
- `workspace:*` dependency with `Node16` moduleResolution requires the dependent package to have `dist/` built
- Biome collapses short ternaries, method chains onto one line when they fit within lineWidth
- Biome sorts imports alphabetically by module path
- Commander command registration pattern: extract `registerXxx(cmd: Command)` functions in separate files
- tsup multi-entry: `tsup src/index.ts src/bin.ts --format esm --dts` for CLI packages
- readline/promises tests: use PassThrough streams with delayed line feeding
- Tests run from `packages/<pkg>/` as cwd — use `resolve(process.cwd(), "..", "..", ...)` to reach repo root
- Biome sorts named imports alphabetically within `{ }` blocks
- Skill directory name != frontmatter `name` — use `skill.path` for file lookups
- `yaml` npm package for YAML frontmatter parsing
- `croner` Cron class: `new Cron(expr, { timezone }).nextRun()` returns `Date | null`
- croner uses system local timezone by default — always pass `timezone: "UTC"` in tests
- Zod discriminated union requires kind-narrowing before accessing variant-specific fields
- `createAgentLoop` accepts optional `toolRegistry` param so gateway can pre-populate tools
- Biome wraps function arguments when they're inside another function call and exceed lineWidth
- vi.useFakeTimers() + vi.advanceTimersByTimeAsync() for timer tests
- CronService pattern: start after channels, stop before channels on shutdown
- HeartbeatService pattern: same start/stop lifecycle as CronService in gateway
- When adding new config fields, must `pnpm --filter @featherbot/core build` before CLI can typecheck
- Biome collapses short import lists to one line (even 3 named imports if they fit in lineWidth)
- TypeScript strict: `let resolveFirst: (() => void) | undefined` for Promise resolve callbacks
- grammy mock pattern: vi.mock("grammy"), capture `on()` handlers in a Map, mock api.sendMessage
- Biome forbids `!` non-null assertions in test files too — use `?.()` optional chain calls
- Baileys v7: `vi.hoisted()` required for mock variables used in `vi.mock()` factory (factory is hoisted above declarations)
- CronTool pattern: thin tool wrapper around a service class, constructor-injected dependency
- SpawnTool follows CronTool pattern: constructor accepts SubagentManager + mutable originContext
- SubagentManager: own AgentLoop instances (not reuse main), reduced tool set (5 tools only)
- Mutable origin context pattern: gateway subscribes to `message:inbound` to update context before adapter processes
- vi.waitFor() for async sub-agent completion assertions (avoids manual timers for fast tasks)
- Mock globalThis.fetch: save original in beforeEach, restore in afterEach, assign vi.fn() in test
- Tool count assertions: createToolRegistry registers 7 tools (5 core + 2 web)
- Gateway uses minimal interfaces (GatewayAdapter, GatewayBus, etc.) to avoid cross-package coupling
- Biome collapses short method chains like `.getChannels().map(...)` onto one line
- Headless mode: check `process.stdin.isTTY` to skip terminal channel in Docker/CI
- Object.defineProperty for mocking process.stdin.isTTY in tests (configurable: true for restore)

---

### US-001 - Dockerfile (Multi-stage Build) (DONE)
**Files modified:**
- Dockerfile (new)

**Learnings:**
- Multi-stage Docker: deps → build → runtime pattern keeps image lean
- better-sqlite3 needs python3 + make + g++ in build stage, only libstdc++6 at runtime
- corepack enable + corepack prepare pnpm@version for pnpm in Docker
- node:22-slim (Debian) avoids musl/Alpine issues with native modules
- COPY individual package.json files for each workspace package for layer caching
- pnpm install --frozen-lockfile --prod for runtime stage (no devDeps)

---

### US-002 - .dockerignore (DONE)
**Files modified:**
- .dockerignore (new)

**Learnings:**
- Exclude test files (*.test.ts), planning files (tasks/, prd.json, progress.txt), IDE dirs
- Keep .dockerignore aligned with .gitignore patterns but also exclude .git/ itself

---

### US-003 - .env.example (DONE)
**Files modified:**
- .env.example (new)

**Learnings:**
- Config loader uses `FEATHERBOT_` prefix with `__` as nested separator
- All config variables derived from packages/core/src/config/schema.ts
- Document defaults as comments next to each variable

---

### US-004 - Headless Mode (Skip Terminal Channel) (DONE)
**Files modified:**
- packages/cli/src/commands/gateway.ts (modified)
- packages/cli/src/commands/gateway.test.ts (new)

**Learnings:**
- process.stdin.isTTY is undefined (falsy) when no TTY, true when TTY attached
- Gateway test mocking: mock all 4 packages (@featherbot/bus, channels, core, scheduler)
- Object.defineProperty with configurable: true to mock/restore process.stdin.isTTY

---

### US-005 - docker-compose.yml (DONE)
**Files modified:**
- docker-compose.yml (new)

**Learnings:**
- No external services needed — SQLite is embedded
- Named volume for persistent data avoids data loss on container recreation
- env_file: .env keeps secrets out of compose file

---

### US-006 - Build Smoke Test (DONE)
**Files modified:**
- Dockerfile (updated smoke test comments)

**Learnings:**
- Smoke test is manual verification — no automated Docker test in CI
- Gateway SIGTERM handler already present from M19 implementation
- Document smoke test commands in Dockerfile header for discoverability

---
